<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<title>物联网操作系统AliOS Things 3.3: udata</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygenextra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="topbanner"><a href="https://github.com/Tencent/rapidjson" title="RapidJSON GitHub"><i class="githublogo"></i></a></div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.9.1 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('udata.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">udata </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md623"></a>
概述</h1>
<p>uData 框架设计思想是基于传统 sensorhub 概念基础之上的，结合IoT的业务场景和 AliOS Things 物联网操作系统的特点设计而成的一个面对 IoT 的感知设备处理框架。uData主要分kernel和framework两层，kernel层主要是负责传感器驱动和相关的静态校准，包括轴向校准等；framework层主要是负责应用服务管理、动态校准管理和对外模块接口等。 </p>
<h2><a class="anchor" id="autotoc_md624"></a>
组件支持以下功能：</h2>
<ul>
<li>传感器框架</li>
<li>集成传感器驱动</li>
<li>静态校准</li>
<li>动态校准算法</li>
<li>数据到云</li>
</ul>
<h2><a class="anchor" id="autotoc_md625"></a>
版权信息</h2>
<blockquote class="doxtable">
<p>Apache license v2.0 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md626"></a>
目录结构</h2>
<div class="fragment"><div class="line">.</div>
<div class="line">├── abs_data_model  # abs layer</div>
<div class="line">├── cali_data       # calibration algorithm</div>
<div class="line">├── include</div>
<div class="line">├── service         # application services</div>
<div class="line">└── service_mgr     # service manager</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md627"></a>
依赖组件</h2>
<ul>
<li>ulog</li>
<li>vfs</li>
<li>sensor</li>
</ul>
<h1><a class="anchor" id="autotoc_md628"></a>
常用配置</h1>
<p>系统中相关配置已有默认值，一般无需修改配置</p>
<h1><a class="anchor" id="autotoc_md629"></a>
API说明</h1>
<p>udata_init() udata框架初始化</p>
<p>udata_register_msg_handler() 注册接收传感器数据的消息句柄函数</p>
<p>udata_subscribe() 订阅传感器服务</p>
<p>udata_report_publish() 读取传感器数据</p>
<h1><a class="anchor" id="autotoc_md630"></a>
使用示例 – uData 本地演示</h1>
<p>基于 uData 获取传感器数据，并在本地进行打印，参考 example/udata_cloud_demo.c</p>
<p>以运行 helloworld_demo 为例，具体步骤如下：</p>
<h2><a class="anchor" id="autotoc_md631"></a>
1. 选择要使用的开发板</h2>
<blockquote class="doxtable">
<p>solutions/helloworld_demo/package.yaml 基础信息 solution 中配置要使用的开发板，默认是 haas100，如果使用 haaseduk1，修改如下 </p>
</blockquote>
<div class="fragment"><div class="line">solution:</div>
<div class="line">  cpu_id: cpu0</div>
<div class="line">  board_name: haaseduk1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md632"></a>
2. 添加示例代码</h2>
<blockquote class="doxtable">
<p>solutions/helloworld_demo/package.yaml 配置信息 def_config 中添加要运行的 example 示例代码和 Sensor 设备驱动的宏。例如温湿度传感器 si7006 数据并在本地进行打印： </p>
</blockquote>
<div class="fragment"><div class="line">def_config:</div>
<div class="line">  AOS_UDATA_LOCAL_DEMO_ENABLE: 1</div>
<div class="line">  AOS_SENSOR_HUMI_SI_SI7006: 1</div>
<div class="line">  AOS_SENSOR_TEMP_SI_SI7006: 1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md633"></a>
3. 添加 udata 组件</h2>
<blockquote class="doxtable">
<p>solutions/helloworld_demo/package.yaml 依赖信息 depends 中添加 udata 组件 </p>
</blockquote>
<div class="fragment"><div class="line">depends:</div>
<div class="line">  - cli: dev_aos</div>
<div class="line">  - osal_aos: dev_aos</div>
<div class="line">  - haaseduk1: dev_aos</div>
<div class="line">  - udata: dev_aos</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md634"></a>
4. 编译</h2>
<div class="fragment"><div class="line">cd solutions/helloworld_demo &amp;&amp; aos make</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md635"></a>
5. 烧录固件</h2>
<blockquote class="doxtable">
<p>参考具体板子的快速开始文档。 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md636"></a>
6. 示例测试</h2>
<blockquote class="doxtable">
<p>CLI命令行输入： </p>
</blockquote>
<div class="fragment"><div class="line">udata_local_test</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md637"></a>
7. 关键日志</h2>
<blockquote class="doxtable">
<p>CLI日志： </p>
</blockquote>
<div class="fragment"><div class="line">Temperature value :</div>
<div class="line">Humidity value :</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md638"></a>
使用示例 – uData 连云演示</h1>
<p>基于uData 获取传感器数据，并通过linkkit上传到云端，参考 example/udata_cloud_demo.c</p>
<p>以运行 link_solo_demo 为例，具体步骤如下：</p>
<h2><a class="anchor" id="autotoc_md639"></a>
1. 选择要使用的开发板</h2>
<blockquote class="doxtable">
<p>solutions/link_solo_demo/package.yaml 基础信息 solution 中配置要使用的开发板，默认是 haas100，如果使用 haaseduk1，修改如下 </p>
</blockquote>
<div class="fragment"><div class="line">solution:</div>
<div class="line">  cpu_id: cpu0</div>
<div class="line">  board_name: haaseduk1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md640"></a>
2. 添加示例代码</h2>
<blockquote class="doxtable">
<p>solutions/link_solo_demo/package.yaml 配置信息 def_config 中添加要运行的 example 示例代码和 Sensor 设备驱动的宏。例如温湿度传感器 si7006 数据并通过 linkkit 上传到云端： </p>
</blockquote>
<div class="fragment"><div class="line">def_config:</div>
<div class="line">  AOS_UDATA_CLOUD_DEMO_ENABLE: 1</div>
<div class="line">  AOS_SENSOR_HUMI_SI_SI7006: 1</div>
<div class="line">  AOS_SENSOR_TEMP_SI_SI7006: 1</div>
</div><!-- fragment --> <blockquote class="doxtable">
<p>solutions/link_solo_demo/main.c 函数 entry_func 添加 udata_cloud_test_init() 函数调用 </p>
</blockquote>
<div class="fragment"><div class="line">extern void udata_cloud_test_init(void);</div>
<div class="line"> </div>
<div class="line">static void entry_func(void *data)</div>
<div class="line">{</div>
<div class="line">    udata_cloud_test_init();</div>
<div class="line">    demo_main(0 , NULL);</div>
<div class="line">}</div>
</div><!-- fragment --> <blockquote class="doxtable">
<p>solutions/link_solo_demo/data_model_basic_demo.c 的 demo_main() 函数 </p>
</blockquote>
<p>- 替换自己在阿里云物联网平台上创建设备的三元组信息 </p><div class="fragment"><div class="line">int demo_main(int argc, char *argv[])</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    /* TODO: 替换为自己设备的三元组 */</div>
<div class="line">    char *product_key       = &quot;a1eykua9RBq&quot;;</div>
<div class="line">    char *device_name       = &quot;haas-edu-k1-calon&quot;;</div>
<div class="line">    char *device_secret     = &quot;589bb9ff1d55675096ba6ba2e0d52392&quot;;</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>声明全局 DATA-MODEL 实例 <div class="fragment"><div class="line">void *g_dm_handle = NULL;</div>
<div class="line"> </div>
<div class="line">int demo_main(int argc, char *argv[])</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    /* 创建DATA-MODEL实例 */</div>
<div class="line">    dm_handle = aiot_dm_init();</div>
<div class="line">    if (dm_handle == NULL) {</div>
<div class="line">        printf(&quot;aiot_dm_init failed&quot;);</div>
<div class="line">        return -1;</div>
<div class="line">    }</div>
<div class="line">    g_dm_handle = dm_handle;</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>注释掉其它属性上报和事件上报， <div class="fragment"><div class="line">int demo_main(int argc, char *argv[])</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    /* 主循环进入休眠 */</div>
<div class="line">    while (1) {</div>
<div class="line">        /* TODO: 以下代码演示了简单的属性上报和事件上报, 用户可取消注释观察演示效果 */</div>
<div class="line">        // demo_send_property_post(dm_handle, &quot;{\&quot;LightSwitch\&quot;: 0}&quot;);</div>
<div class="line">        // demo_send_event_post(dm_handle, &quot;Error&quot;, &quot;{\&quot;ErrorCode\&quot;: 0}&quot;);</div>
<div class="line"> </div>
<div class="line">        aos_msleep(1000);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --> </li>
</ul>
<h2><a class="anchor" id="autotoc_md641"></a>
3. 添加 udata 组件</h2>
<blockquote class="doxtable">
<p>solutions/link_solo_demo/package.yaml 依赖信息 depends 中添加 udata 组件 </p>
</blockquote>
<div class="fragment"><div class="line">depends:</div>
<div class="line">  - linksdk: dev_aos</div>
<div class="line">  - haaseduk1: dev_aos</div>
<div class="line">  - udata: dev_aos</div>
<div class="line">  - mbedtls: dev_aos</div>
<div class="line">  - netmgr: dev_aos</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md642"></a>
4. 编译</h2>
<div class="fragment"><div class="line">cd solutions/link_solo_demo &amp;&amp; aos make</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md643"></a>
5. 烧录固件</h2>
<blockquote class="doxtable">
<p>参考具体板子的快速开始文档。 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md644"></a>
6. 示例测试</h2>
<h3><a class="anchor" id="autotoc_md645"></a>
设备联网</h3>
<blockquote class="doxtable">
<p>CLI命令行输入：打开连网成功后会自动保存AP信息的功能 </p>
</blockquote>
<div class="fragment"><div class="line">netmgr -t wifi -b 1</div>
</div><!-- fragment --> <blockquote class="doxtable">
<p>CLI命令行输入：netmgr -t wifi -c {ssid} {password} 连接名为ssid的路由器AP，其中 {ssid} {password}替换为自己的路由器配网信息 </p>
</blockquote>
<div class="fragment"><div class="line">netmgr -t wifi -c my_wifi 12345678</div>
</div><!-- fragment --> <blockquote class="doxtable">
<p>设备在联网成功后会自动读取 Sensor 数据并上报到云端，同时可以看到设备在阿里云物联网平台处于在线状态，在日志服务中能查看设备上传到云端的日志信息 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md646"></a>
7. 关键日志</h2>
<blockquote class="doxtable">
<p>CLI日志： </p>
</blockquote>
<div class="fragment"><div class="line">Temperature value : 44.0 centidegree</div>
<div class="line">[172.620][LK-0309] pub: /sys/a1eykua9RBq/haas-edu-k1-calon/thing/event/property/post</div>
<div class="line"> </div>
<div class="line">[LK-030A] &gt; 7B 22 69 64 22 3A 22 31  22 2C 22 76 65 72 73 69 | {&quot;id&quot;:&quot;1&quot;,&quot;versi</div>
<div class="line">[LK-030A] &gt; 6F 6E 22 3A 22 31 2E 30  22 2C 22 70 61 72 61 6D | on&quot;:&quot;1.0&quot;,&quot;param</div>
<div class="line">[LK-030A] &gt; 73 22 3A 7B 22 43 75 72  72 65 6E 74 54 65 6D 70 | s&quot;:{&quot;CurrentTemp</div>
<div class="line">[LK-030A] &gt; 65 72 61 74 75 72 65 22  3A 34 34 2E 30 7D 7D    | erature&quot;:44.0}}</div>
<div class="line"> </div>
<div class="line">[ 172.652]&lt;A&gt;AOS sensor:  humidity: 16.823683</div>
<div class="line"> </div>
<div class="line">[172.673][LK-0309] pub: /sys/a1eykua9RBq/haas-edu-k1-calon/thing/event/property/post_reply</div>
<div class="line"> </div>
<div class="line">[LK-030A] &lt; 7B 22 63 6F 64 65 22 3A  32 30 30 2C 22 64 61 74 | {&quot;code&quot;:200,&quot;dat</div>
<div class="line">[LK-030A] &lt; 61 22 3A 7B 7D 2C 22 69  64 22 3A 22 31 22 2C 22 | a&quot;:{},&quot;id&quot;:&quot;1&quot;,&quot;</div>
<div class="line">[LK-030A] &lt; 6D 65 73 73 61 67 65 22  3A 22 73 75 63 63 65 73 | message&quot;:&quot;succes</div>
<div class="line">[LK-030A] &lt; 73 22 2C 22 6D 65 74 68  6F 64 22 3A 22 74 68 69 | s&quot;,&quot;method&quot;:&quot;thi</div>
<div class="line">[LK-030A] &lt; 6E 67 2E 65 76 65 6E 74  2E 70 72 6F 70 65 72 74 | ng.event.propert</div>
<div class="line">[LK-030A] &lt; 79 2E 70 6F 73 74 22 2C  22 76 65 72 73 69 6F 6E | y.post&quot;,&quot;version</div>
<div class="line">[LK-030A] &lt; 22 3A 22 31 2E 30 22 7D                          | &quot;:&quot;1.0&quot;}</div>
<div class="line"> </div>
<div class="line">[172.674][LK-0A08] DM recv generic reply</div>
<div class="line">demo_dm_recv_handler, type = 0</div>
<div class="line">msg_id = 1, code = 200, data = {}, message = success</div>
<div class="line">[ 174.620]&lt;A&gt;AOS sensor:  temperature: 44.023758</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md647"></a>
注意事项</h1>
<p>sensor设备驱动 components/sensor/drv/drv_####_####_####.c 中 i2c_dev_t 结构体成员 port 要与 sensor_i2c_init() 初始化中的 port 相同。 </p><div class="fragment"><div class="line">void i2c_init(void)</div>
<div class="line">{</div>
<div class="line">    i2c_dev_t i2c_dev;</div>
<div class="line">    i2c_dev.port                 = 1;</div>
<div class="line">    i2c_dev.config.address_width = I2C_HAL_ADDRESS_WIDTH_7BIT;</div>
<div class="line">    i2c_dev.config.freq          = I2C_BUS_BIT_RATES_100K;</div>
<div class="line">    i2c_dev.config.mode          = I2C_MODE_MASTER;</div>
<div class="line"> </div>
<div class="line">    sensor_i2c_init(&amp;i2c_dev);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">i2c_dev_t ####_ctx = {</div>
<div class="line">    .port                 = 1,</div>
<div class="line">    .config.address_width = I2C_HAL_ADDRESS_WIDTH_7BIT,</div>
<div class="line">    .config.freq          = I2C_BUS_BIT_RATES_100K,</div>
<div class="line">    .config.mode          = I2C_MODE_MASTER,</div>
<div class="line">    .config.dev_addr      = SI7006_I2C_ADDRESS,</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md648"></a>
FAQ</h1>
<p>Q1： 怎么自己添加特定型号的传感器驱动程序？ </p><blockquote class="doxtable">
<p>1. 参考 components/sensor/drv/drv_####_####_####.c 已集成的传感器设备驱动编写驱动文件； </p>
</blockquote>
<blockquote class="doxtable">
<p>2. components/sensor/drv/drv_init.c 中添加驱动程序的宏开关, 如 </p>
</blockquote>
<div class="fragment"><div class="line">#if AOS_SENSOR_TEMP_SI_SI7006</div>
<div class="line">    drv_temp_si_si7006_init();</div>
<div class="line">#endif</div>
</div><!-- fragment --> <blockquote class="doxtable">
<p>3. components/sensor/package.yaml 中添加参与编译的源代码文件 </p>
</blockquote>
<div class="fragment"><div class="line">source_file:</div>
<div class="line">  - drv/drv_temp_humi_si_si7006.c ? &lt;AOS_SENSOR_TEMP_SI_SI7006&gt;</div>
</div><!-- fragment --><p> 更具体的操作可以参考下面链接：</p><ul>
<li><a href="https://github.com/alibaba/AliOS-Things/wiki/AliOS-Things-uData-Framework-Porting-Guide">AliOS Things uData Framework Porting Guide</a></li>
<li><a href="https://github.com/alibaba/AliOS-Things/wiki/AliOS-Things-uData-Sensor-Driver-Porting-Guide">AliOS Things uData Sensor Driver Porting Guide</a></li>
<li><a href="https://github.com/alibaba/AliOS-Things/wiki/AliOS-Things-uData%E7%AC%AC%E4%B8%89%E6%96%B9%E7%AE%97%E6%B3%95%E7%A7%BB%E6%A4%8D%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3">AliOS Things uData第三方算法移植说明文档</a></li>
<li><a href="https://github.com/alibaba/AliOS-Things/wiki/%E4%BC%A0%E6%84%9F%E5%99%A8%E6%95%B0%E6%8D%AE%E4%B8%80%E9%94%AE%E5%BC%8F%E4%B8%8A%E4%BA%91%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E">传感器数据一键式上云的使用说明</a></li>
<li><a href="https://github.com/alibaba/AliOS-Things/wiki/%E5%9F%BA%E4%BA%8EAliOS-Things-Developer-Kit%E5%BC%80%E5%8F%91%E6%9D%BF%E7%9A%84%E5%A4%96%E6%8E%A5%E4%BC%A0%E6%84%9F%E5%99%A8%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B">基于AliOS Things Developer Kit开发板的外接传感器开发教程</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
</body>
</html>
