# ESP32 公测说明
&emsp;&emsp;
ESP32是开源世界中被开发者普遍使用的开发板，在ESP32中同样可以使用Python语言基于HaaS开发框架进行轻应用开发。前提是ESP32设备中有烧录HaaS开发团队发布的ESP32 HaaS Python标准固件。

&emsp;&emsp;
本文主要介绍如下三部分：
1. ESP32 HaaS标准固件烧录
2. helloworld Python程序的运行
3. 公测路径的说明

## PC环境准备
&emsp;&emsp;
将ESP32开发板用Micro-USB数据线和电脑USB口相连。

### HaaS Studio安装
&emsp;&emsp;
HaaS Studio目前是以插件的形式安装在VS Code（Visual Studio Code）工具中，所以安装HaaS Studio之前需要先安装VS Code。

#### 安装VS Code

&emsp;&emsp;
读者请到[微软官方网站](https://code.visualstudio.com/)上下载 VS Code 安装包并进行安装，VS Code安装包要求不低于版本 1.57。

&emsp;&emsp;
VS Code安装包下载网站： https://code.visualstudio.com/

> 推荐 Windows 系统版本为 win10， MacOS 版本不低于 10.15。
<br>

#### 安装haas-studio插件

&emsp;&emsp;
安装完 VS Code之后，请点击如下链接下载HaaS-Studio插件（目前还没有正式发布到线上），下载完成后解压缩，然后按照下图中数字的指示步骤完成haas-studio插件的安装。
* [HaaS-Studio插件1.0.61下载链接](https://hli.aliyuncs.com/o/config/HaaSStudio/haas-studio-for-open-test.zip)
  * HaaS Studio 1.0.61更新说明
    * 优化脚本推送流程，确保更高推送效率和成功率

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaS_Studio_offline_install.png width=80%/>
</div>

&emsp;&emsp;
插件安装完成后，则 VS Code 左下角的状态栏会显示"快速开始"的图标，如下图所示。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_新建工程按钮.png width=80%/>
</div>

### ESP32串口名称确认
#### Windows系统

&emsp;&emsp;
如果您的电脑是Windows系统，请通过控制面板下的设备管理器，查询当前电脑下ESP32插入后新增的端口。下图中显示ESP32连接后新增的串口为“COM7”。
> 注意：每台PC的串口可能都不一样，如果有多个串口，可以断开PC和ESP32之间的连线，然后将PC和ESP32相连，找到新增的那个串口。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_EDU_K1_WINDOWS_COM.png width=70%/>
</div>

&emsp;&emsp;
如果电脑在连接ESP32之前和之后，没有新增串口，则需要安装ESP32的串口驱动。ESP32串口芯片有两种，请根据自己的ESP32型号选择合适的驱动（如果您不知道自己的ESP32型号，两个驱动都安装上即可）：
* [CH340串口驱动下载页](http://www.wch.cn/downloads/CH341SER_ZIP.html)
* [CP2102驱动下载](https://www.silabs.com/documents/public/software/CP210x_Universal_Windows_Driver.zip)
<br>

#### MAC系统

&emsp;&emsp;
如果您的电脑是MAC系统，系统会自带ESP32 UART驱动程序，无需单独安装。可以在命令行中通过如下命令查看ESP32接到电脑之前和之后串口列表的差异确认ESP32串口名称。

```
# 接入ESP32之前
(base) ➜  ~ ls /dev/tty.usb*
zsh: no matches found: /dev/tty.usb*

# 接入ESP32之后
(base) ➜  ~ ls /dev/tty.usb*
/dev/tty.usbserial-0001
```

&emsp;&emsp;
其中接入ESP32之后新出现的"/dev/tty.usbserial-0001"即为ESP32所对应的串口。
> 注意：每台PC的串口可能都不一样，上面只是笔者电脑上面的串口信息。
<br>

## ESP32 HaaS Python基础固件烧录

### 固件下载

&emsp;&emsp;
请通过下面固件列表链接下载开发板对应的固件压缩包并解压，解压完成后可以看到其目录结构如下：
```
├── HaaSPython-esp32-{board}-{xxx}.bin   # HaaS官方固件，{board}为开发版型号，{xxx}为版本号
```

&emsp;&emsp;
### ESP32 NodeMCU固件列表
* [ESP32-NodeMCU最新固件](https://hli.aliyuncs.com/o/config/HaaS_Python/HaaSPython-esp32-nodemcu32s.zip)

  * NodeMCU-32S最新固件v0.1.7版本更新说明（2020-12-20）
    * 更换vfatfs到 littlefs，节省20K内存
    * 优化系统内存管理策略，缓解内存不足问题
    * 增加statvfs接口
    * 修复spi open失败问题
    * 修复https概率失败问题
    * kv分区放到最后的分区
    * 支持文件系统打包到固件中，提供外部文件到系统固件的集成
    * 支持通过KV确定是否启动一分钟上云功能
    * 完善系统内存调试命令
    * 新增一分钟上云功能

### 固件烧录

&emsp;&emsp;
请参考下面的步骤进行HaaS Python固件的烧录。

1. 点击“快速开始”按钮后选择“烧录工具”按钮。如下图所示。
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_固件烧录.png width=75%/>
</div>

2. 选择好ESP32对应的“串口名字”和固件所在路径（上面步骤中解压出来的名为HaaSPython-esp32-nodemcu32s-xxx.bin的文件）之后点击“开始烧录”按钮，HaaS Studio便会将此固件烧录到开发板中，如下图所示。

> 下图中是笔者电脑中的串口好和固件名称，请读者按照根据串口和固件实际路径进行选择。

> 如果“串口名字”下拉框中没有正确的串口号，可以拔插ESP32的USB口后，点击“刷新”按钮刷新串口列表。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_固件烧录_开始烧录.png width=85%/>
</div>

&emsp;&emsp;
烧录过程中命令行窗口会输出如下日志，烧录完成，中断日志中会提示"Hash of data verified."。

```
Serial port /dev/cu.usbserial-0001
Connecting.......
Detecting chip type... Unsupported detection protocol, switching and trying again...
Connecting....
Detecting chip type... ESP32
Chip is ESP32-D0WD (revision 1)
Features: WiFi, BT, Dual Core, 240MHz, VRef calibration in efuse, Coding Scheme None
Crystal is 40MHz
MAC: 8c:ce:4e:9a:67:ec
Uploading stub...
Running stub...
Stub running...
Changing baud rate to 460800
Changed.
Erasing flash (this may take a while)...
Chip erase completed successfully in 13.0s
Hard resetting via RTS pin...

...
Changing baud rate to 460800
Changed.
Configuring flash size...
Flash will be erased from 0x00001000 to 0x001e3fff...
Compressed 1977072 bytes to 1172201...
Wrote 1977072 bytes (1172201 compressed) at 0x00001000 in 31.0 seconds (effective 511.0 kbit/s)...
Hash of data verified.

Leaving...
Hard resetting via RTS pin...
```

&emsp;&emsp;
经过上面的步骤HaaS Python ESP32固件就烧录到ESP32开发板中去了。


## ESP32 helloworld例程

### 创建helloworld工程
&emsp;&emsp;
请遵循如下的步骤完成helloworld Python工程的创建。

&emsp;&emsp;
如下图所示，点击HaaS Studio的"快速开始"按键会弹出HaaS Studio的欢迎页面，请选择“创建项目”，如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_创建项目向导.png width=60%/>
</div>

&emsp;&emsp;
根据创建工程向导，开发者输入/选择相关的信息即可。下面以在ESP32上面创建hellworld示例程序为例演示工程进行，步骤如下:
> 注意事项： 文件夹不要有中文，空格及其他异常字符。

1. 输入项目名称
2. 选择工作区所在路径
3. 选择硬件类型
4. 选择编程语言
5. 选择解决方案模板
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_Python创建工程_项目名称.png width=40%/>
</div>

&emsp;&emsp;
然后点击“立即创建”按钮，在随后的步骤中确认输入的信息无误，点击“确认”，等待工程创建完成后，VS Code会自动打开新创建的工程。就可以在左侧的文件浏览页面中看到刚刚创建的helloworld工程。

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_Python_helloworld_代码.png width=80%/>
</div>


### 推送脚本到设备

&emsp;&emsp;
&emsp;&emsp;
点击HaaS-Studio的“部署运行”按钮（<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_部署运行.png width=5%/>），HaaS-Studio会将脚本推送到开发板上。

&emsp;&emsp;
脚本推送完成后，VS Code的命令行窗口会有如下提示：
```
upload success
```

&emsp;&emsp;
如果`推送不成功`请点击下面`"推送失败的解决方案"`按钮查看解决方法。
<details>
<summary>推送失败的解决方案</summary>
&emsp;&emsp;
一般情况下，推送失败是因为电脑上外接了多个USB转串口的设备导致的。此时，VS Code的命令行中会列出系统的串口列表，需要您在命令行中敲入ESP32串口名称（前面“ESP32串口名称确认”步骤中有说明）对应的序号之后敲回车。如下图所示：

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/1_HaaS_Studio_选择串口序号.png width=150%/>
</div>

&emsp;&emsp;
如果选择了串口仍然推送失败，请联系HaaS小二解决推送问题。

</details>

<br>

&emsp;&emsp;
推送此脚本到ESP32之后，HaaS-Studio同时会自动打开串口工具，并自动执行main.py脚本，此时可以在看到设备周期性的打印如下日志。

```
...
helloworld
helloworld
helloworld
...
```

### 例程Python脚本说明

&emsp;&emsp;
helloworld工程中的main.py脚本内容如下，各行代码的功能请参考下面代码的注释。

```python
#!/usr/bin/env python
# -*- encoding: utf-8 -*-

import utime   # 延时函数在utime库中

if __name__ == '__main__':
    while True:             # 无限循环
        print("helloworld")  # 打印"helloworld"字串到串口中
        utime.sleep(1)      # 打印完之后休眠1秒
```

&emsp;&emsp;
helloworld例程运行起来就说明HaaS Python开发环境安装好了。接下来是对公测案例的说明。

# ESP32公测案例说明
&emsp;&emsp;
ESP32快速开始完成之后，公测用户可以开始如下几部分的测试：
* 一分钟上云体验
* 趣味案例
* 教育仓库案例
* HaaS API文档

## 一分钟上云
&emsp;&emsp;
在NodeMCU-32S平台上“一分钟上云体验”案例请参考“ADC采样实验”中说明文档。
* 体验入口：https://haas.iot.aliyun.com/

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/一分钟上云案例入口.png width=80%/>
</div>

## 趣味案例
&emsp;&emsp;
如上图所示，“趣味案例”页面下面的案例都是独立的，每一个都可以单独体验，建议按照下面的顺序依此体验。
* 火焰检测系统
* 花卉养殖系统
* 起夜灯
* 智慧路灯系统
* 燃气检测系统
* GNSS定位系统

## 教育仓库案例
&emsp;&emsp;
教育仓库测试入口：https://haas.iot.aliyun.com/

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaS官网_学习中心入口.png width=80%/>
</div>

&emsp;&emsp;
进入到学习中心的页面之后，请按照学习中心页面从快速开始到各学区依次测试。
<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaS官网_学习中心_公测顺序.png width=80%/>
</div>

## HaaS API文档
&emsp;&emsp;
教育仓库测试入口：https://haas.iot.aliyun.com/

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaS官网_HaaSAPI网页入口.png width=80%/>
</div>

&emsp;&emsp;
进入HaaS API说明文档页之后，请根据您自己想要实现的功能，选择左侧对应的库说明。
> MicroPython标准库下面是MicroPython原生库API说明
> HaaS轻应用扩展库是HaaS Python扩展库的API说明

<div align="center">
<img src=https://hli.aliyuncs.com/haas-static/haasapi/Python/docs/zh-CN/images/HaaSAPI_说明文档.png width=80%/>
</div>

&emsp;&emsp;
在使用过程中如果您有任何疑问（哪怕是一点点的疑问），请直接反馈给我们的HaaS小二。

> 再次感谢您能参与HaaS Python的公测！

<br>
